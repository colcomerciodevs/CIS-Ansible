############################################################
#      CONTROL DE EJECUCIÓN DE SECCIONES CIS RHEL 8
############################################################
rhel8cis_general: true
rhel8cis_section1: true
rhel8cis_section2: true
rhel8cis_section3: true
rhel8cis_section4: true
rhel8cis_section5: true
rhel8cis_section6: true


############################################################
#              SECTION 1.1 – FILESYSTEMS / BÁSICO
############################################################

######## 1.1 – DISABLE FILESYSTEMS ########
rhel8_cis_rule_1_1_1: true
rhel8_cis_rule_1_1_2: true
rhel8_cis_rule_1_1_3: true
rhel8_cis_rule_1_1_4: false
 # Motivo: el arranque UEFI requiere el módulo vfat


######## 1.1 – PARTICIONES Y OPCIONES DE MONTAJE ########

# No existe partición independiente para /tmp
rhel8_cis_rule_1_1_5: false
rhel8_cis_rule_1_1_6: false
rhel8_cis_rule_1_1_7: false
rhel8_cis_rule_1_1_8: false

# /dev/shm existe como partición independiente
rhel8_cis_rule_1_1_9:  true
rhel8_cis_rule_1_1_10: true
rhel8_cis_rule_1_1_11: true
rhel8_cis_rule_1_1_12: true

# No existe partición independiente para /var
rhel8_cis_rule_1_1_13: false
rhel8_cis_rule_1_1_14: false
rhel8_cis_rule_1_1_15: false

# Motivo: montar /var con noexec puede afectar procesos ya existentes
rhel8_cis_rule_1_1_16: false

# No existe partición independiente para /var/tmp
rhel8_cis_rule_1_1_17: false
rhel8_cis_rule_1_1_18: false
rhel8_cis_rule_1_1_19: false
rhel8_cis_rule_1_1_20: false

# No existe partición independiente para /var/log
rhel8_cis_rule_1_1_21: false
rhel8_cis_rule_1_1_22: false
rhel8_cis_rule_1_1_23: false
rhel8_cis_rule_1_1_24: false

# No existe partición independiente para /var/log/audit
rhel8_cis_rule_1_1_25: false
rhel8_cis_rule_1_1_26: false
rhel8_cis_rule_1_1_27: false
rhel8_cis_rule_1_1_28: false

# No existe partición independiente para /home
rhel8_cis_rule_1_1_29: false
rhel8_cis_rule_1_1_30: false
rhel8_cis_rule_1_1_31: false
rhel8_cis_rule_1_1_35: false
rhel8_cis_rule_1_1_36: false

# Medios removibles (controles omitidos en este entorno)
rhel8_cis_rule_1_1_32: false
rhel8_cis_rule_1_1_33: false
rhel8_cis_rule_1_1_34: false

# No existen directorios world-writable sin sticky bit
rhel8_cis_rule_1_1_37: true

# autofs deshabilitado/enmascarado
rhel8_cis_rule_1_1_38: true

# Módulo usb-storage no cargado
rhel8_cis_rule_1_1_39: true


############################################################
#                SECTION 1.7 – BANNERS
############################################################
rhel8_cis_rule_1_7_1: true
rhel8_cis_rule_1_7_2: true
rhel8_cis_rule_1_7_3: true
rhel8_cis_rule_1_7_4: true
rhel8_cis_rule_1_7_5: true
rhel8_cis_rule_1_7_6: true

## Section 1.7: Banner
# Mensajes informativos de uso diario (por ejemplo, anuncios internos). Se muestran después del login.
# Ubicación del archivo MOTD. El archivo debe existir en el directorio 'files' del rol.
motd_file: "Message_Day"

# Mensajes informativos o de advertencia sobre el acceso (por ejemplo, políticas de uso).
# Se muestran antes del login. Afectan a los archivos /etc/issue y /etc/issue.net.
# El archivo debe existir en el directorio 'files' del rol.
issue_file: "login_banner"


############################################################
#          SECTION 2.1 – SERVICIOS DE PROPÓSITO ESPECIAL
############################################################

######## 2.1 – CONFIGURACIÓN DE NTP / SERVICIOS DE TIEMPO ########

## Configure NTP
rhel8_cis_rule_2_1_1: true
rhel8_cis_rule_2_1_2: false # Motivo: se utiliza Chrony como servicio de sincronización de tiempo
rhel8_cis_rule_2_1_3: true

## Section 2.1: Configure NTP
# Método de sincronización de tiempo
rhel8_cis_time_synchronization: chrony

# Servidores NTP centrales configurados
rhel8_cis_time_synchronization_servers:
  - 169.254.169.254

## Uninstall Packages - special purpose services
# Controles para desinstalar servicios de propósito especial no requeridos en el servidor
rhel8_cis_rule_2_1_4: true
rhel8_cis_rule_2_1_5: true
rhel8_cis_rule_2_1_6: true
rhel8_cis_rule_2_1_7: true
rhel8_cis_rule_2_1_8: true
rhel8_cis_rule_2_1_9: true
rhel8_cis_rule_2_1_10: true
rhel8_cis_rule_2_1_11: true
rhel8_cis_rule_2_1_12: true
rhel8_cis_rule_2_1_13: true
rhel8_cis_rule_2_1_14: true
rhel8_cis_rule_2_1_15: true
rhel8_cis_rule_2_1_16: true
rhel8_cis_rule_2_1_17: true
rhel8_cis_rule_2_1_18: true
rhel8_cis_rule_2_1_19: true
rhel8_cis_rule_2_1_20: true
rhel8_cis_rule_2_1_21: true
rhel8_cis_rule_2_1_22: false # Motivo: utilizado para tareas de backup y sincronización
rhel8_cis_rule_2_1_23: true

## Section 2.1: Uninstall packages
# Lista de paquetes a verificar y desinstalar si no son necesarios
packages_to_check:
  - xinetd
  - xorg-x11-server-*
  - avahi
  - avahi-autoipd
  - cups
  - dhcpd
  - openldap-servers
  - nfs-utils
  - nfs-kernel-server
  - bind
  - bind-chroot
  - vsftpd
  - tftp-server
  - httpd
  - dovecot
  - samba
  - squid
  - net-snmp
  - telnet-server
  - rsync
  - ypserv


############################################################
#                SECTION 2.2 – CLIENTES DE SERVICIOS
############################################################

## Uninstall Packages - service clients
# Controles para desinstalar clientes de servicios no necesarios
rhel8_cis_rule_2_2_1: true
rhel8_cis_rule_2_2_2: true
rhel8_cis_rule_2_2_3: true
rhel8_cis_rule_2_2_4: true
rhel8_cis_rule_2_2_5: true
rhel8_cis_rule_2_2_6: true
rhel8_cis_rule_2_2_7: false # Motivo: /reportes está montado en NFSv3 y requiere rpcbind obligatoriamente


############################################################
# SECTION 3.1 – DESHABILITAR DISPOSITIVOS/PROTOCOLOS DE RED NO USADOS
############################################################

### Section 3 rules
# Deshabilitar protocolos y dispositivos de red no utilizados
rhel8_cis_rule_3_1_1: true
rhel8_cis_rule_3_1_2: true

## Section 3.1: Disable Net Proto
# Requerimiento de IPv6 en el sistema. false = no requerido.
rhel8_cis_ipv6_required: false


############################################################
#         SECTION 3.2 – PARÁMETROS DE RED (HOST ONLY)
############################################################

# Configuración de parámetros de red a nivel de host
rhel8_cis_rule_3_2_1: true
rhel8_cis_rule_3_2_2: true


############################################################
#      SECTION 3.3 – PARÁMETROS DE RED (HOST AND ROUTER)
############################################################

# Configuración de parámetros de red para host y router
rhel8_cis_rule_3_3_1: true
rhel8_cis_rule_3_3_2: true
rhel8_cis_rule_3_3_3: true
rhel8_cis_rule_3_3_4: true
rhel8_cis_rule_3_3_5: true
rhel8_cis_rule_3_3_6: true
rhel8_cis_rule_3_3_7: true
rhel8_cis_rule_3_3_8: true
rhel8_cis_rule_3_3_9: true


############################################################
#       SECTION 3.4 – PROTOCOLOS DE RED NO COMUNES
############################################################

# Configuración de protocolos de red poco comunes / no utilizados
rhel8_cis_rule_3_4_1: true
rhel8_cis_rule_3_4_2: true
rhel8_cis_rule_3_4_3: true
rhel8_cis_rule_3_4_4: true


############################################################
#  SECTION 5.1 – CONFIGURAR JOBS PROGRAMADOS BASADOS EN TIEMPO
############################################################

# Configuración de trabajos programados basados en tiempo (cron/at)
rhel8_cis_rule_5_1_1: true
rhel8_cis_rule_5_1_2: true
rhel8_cis_rule_5_1_3: true
rhel8_cis_rule_5_1_4: true
rhel8_cis_rule_5_1_5: true
rhel8_cis_rule_5_1_6: true
rhel8_cis_rule_5_1_7: true
rhel8_cis_rule_5_1_8: true # Con excepciones controladas
rhel8_cis_rule_5_1_9: true # Con excepciones controladas

# 5.1.8 - Authorized cron users
# IMPORTANTE: únicamente los usuarios listados en /etc/cron.allow tienen permisos para programar cron
authorized_cron_users:
  - root
  - adminso
  - opc
  - psoft
  - oracle
  - oracle2

# 5.1.9 - Authorized at users
# IMPORTANTE: únicamente los usuarios listados en /etc/at.allow tienen permisos para programar at
authorized_at_users:
  - root
  - adminso
  - opc
  - psoft
  - oracle
  - oracle2


# ------------------------------------------------------------------
#                            SUDO
# ------------------------------------------------------------------

# Configure SUDO
rhel8_cis_rule_5_2_1: true
rhel8_cis_rule_5_2_2: true
rhel8_cis_rule_5_2_3: true
rhel8_cis_rule_5_2_4: true
rhel8_cis_rule_5_2_5: true
rhel8_cis_rule_5_2_6: true
rhel8_cis_rule_5_2_7: true
rhel8_cis_rule_5_2_8: true
rhel8_cis_rule_5_2_9: true

## Control 5.2.3 - Ensure sudo log file exists
# Por defecto, sudo registra mediante syslog(3).
# Esta variable permite especificar un archivo de log dedicado para sudo.
# Define la ruta y nombre del archivo de log de sudo.
rhel8_cis_sudolog_location: "/var/log/sudo.log"

## Control 5.2.4 - Ensure that a password must be provided for user escalation
# Usuarios excluidos de la eliminación de NOPASSWD en reglas de sudo gestionadas por Ansible.
sudoers_exclude_nopasswd_users:
  - adminso
  - proactiva
  - iacolcoauto
  - ansible_test
  - psoft
  - opc
  - oracle-cloud-agent
  - oracle-cloud-agent-updater

## Control 5.2.6 - Ensure sudo authentication timeout is configured correctly
# Duración (en minutos) durante la cual las credenciales de autenticación de sudo
# se almacenan en caché tras una autenticación exitosa.
# CIS requiere un valor de 15 minutos o menos.
rhel8_cis_sudo_timestamp_timeout: 15

## Control 5.2.7 - Ensure access to the 'su' command is restricted
# Nombre del grupo que está autorizado a usar el comando 'su'.
# CIS requiere que este grupo exista y se mantenga vacío (control mediante sudo).
rhel8_cis_sugroup: nosugroup

# Lista de usuarios autorizados a utilizar el comando 'su' (según política local).
authorized_su_users:
  - root
  - adminso
  - opc
  - psoft
  - aromero
  - csotomonte
  - jcastano

## Section 5.2 - Configure authselect: Custom authselect profile settings (name, profile to customize, options)
## Controls:
#  - 5.2.8 - Ensure custom authselect profile is used ('custom_profile_name', 'default_file_to_copy')
#  - 5.2.9 - Ensure authselect includes with-faillock en el perfil personalizado
# Nota: Las configuraciones actuales son de ejemplo y deben ajustarse a la política del sitio.
rhel8_cis_authselect:
  # Nombre del perfil personalizado que se creará y seleccionará.
  custom_profile_name: custom-profile
  # ID del perfil existente que se utilizará como base (por ejemplo: "sssd --symlink-meta").
  default_file_to_copy: "sssd --symlink-meta"
  # Modificadores predefinidos a aplicar al perfil.
  options: with-sudo with-faillock without-nullok


## Control 5.2.8 - Ensure custom authselect profile is used
# Controla si se debe crear automáticamente un perfil personalizado de authselect
# copiando y personalizando uno de los perfiles por defecto (sssd, winbind o nis).
rhel8_cis_authselect_custom_profile_create: true

## Control 5.2.9 - Ensure authselect includes with-faillock | Create custom profiles
# Controla si se debe seleccionar el perfil personalizado existente.
# Nota: las futuras actualizaciones sobre la plantilla base se propagarán al perfil personalizado.
rhel8_cis_authselect_custom_profile_select: true


# ------------------------------------------------------------------
#                           SSH SERVER
# ------------------------------------------------------------------

# SSH Server hardening (CIS Section 5.3)
rhel8_cis_rule_5_3_1: true
rhel8_cis_rule_5_3_2: true
rhel8_cis_rule_5_3_3: true
rhel8_cis_rule_5_3_4: true
rhel8_cis_rule_5_3_5: true
rhel8_cis_rule_5_3_6: true
rhel8_cis_rule_5_3_7: true
rhel8_cis_rule_5_3_8: true
rhel8_cis_rule_5_3_9: true
rhel8_cis_rule_5_3_10: true
rhel8_cis_rule_5_3_11: true
rhel8_cis_rule_5_3_12: true
rhel8_cis_rule_5_3_13: true
rhel8_cis_rule_5_3_14: true
rhel8_cis_rule_5_3_15: true
rhel8_cis_rule_5_3_16: true
rhel8_cis_rule_5_3_17: true
rhel8_cis_rule_5_3_18: true
rhel8_cis_rule_5_3_19: true

## Options Server SSH
# Controles:
# - 5.3.4  - Limitar acceso SSH
# - 5.3.13 - Configurar tiempo de inactividad (Idle Timeout Interval)
# - 5.3.14 - Configurar LoginGraceTime a un minuto o menos
rhel8_cis_sshd:

  # Lista de patrones de usuarios permitidos para conectarse por SSH (AllowUsers).
  # Formato opcional USER@HOST restringe acceso al host indicado.
  ### allowusers: user1 user2    # Definir usuarios específicos que pueden conectarse por SSH

  # Lista de patrones de grupos permitidos para conectarse por SSH (AllowGroups).
  # Los usuarios cuyo grupo primario o suplementario coincida podrán acceder por SSH.
  # Aquí se definen los grupos con permiso de acceso SSH.
  allowgroups: ssh_access

  # Lista de patrones de usuarios a los que se les niega acceso SSH (DenyUsers).
  # Formato opcional USER@HOST restringe el bloqueo al host indicado.
  ### denyusers: "nobody"        # Definir usuarios a los que se les deniega el acceso SSH

  # Lista de patrones de grupos a los que se les niega acceso SSH (DenyGroups).
  ### denygroups: ""             # Definir grupos a los que se les deniega el acceso SSH

  # Número máximo de mensajes "keep-alive" sin respuesta antes de cerrar la conexión.
  clientalivecountmax: 3

  # Intervalo (en segundos) entre mensajes "keep-alive" enviados por el servidor al cliente.
  # Ayuda a mantener la sesión activa y a detectar inactividad.
  clientaliveinterval: 900

  # Tiempo (en segundos) permitido para completar la autenticación SSH antes de que el servidor
  # cierre la conexión.
  logingracetime: 60

  # La opción MaxStartups controla el número de conexiones SSH no autenticadas simultáneas
  # que el servidor permitirá antes de empezar a rechazar nuevas conexiones.
  maxstartups: 10:30:60


# ------------------------------------------------------------ 
#                          PAM
# ------------------------------------------------------------ 

# Configure PAM
## authselect personalizado: alto riesgo de impacto si se aplica sin pruebas
rhel8_cis_rule_5_4_1: true # Depende de authselect - módulo pwquality habilitado por defecto en perfil sssd
rhel8_cis_rule_5_4_2: true # Depende del perfil personalizado de authselect para agregar módulo faillock
rhel8_cis_rule_5_4_3: true # Depende del perfil personalizado de authselect para agregar módulo pam_pwhistory
rhel8_cis_rule_5_4_4_authselect: true # Módulo pam_unix.so con SHA-512 por defecto en perfil sssd; se debe reflejar en el perfil personalizado
rhel8_cis_rule_5_4_4: true # Configuración que no depende de authselect

## Section 5.4: Configure PAM
rhel8_cis_pam_faillock:
  # Tiempo (en segundos) tras alcanzar el máximo de intentos fallidos antes de desbloquear al usuario.
  unlock_time: 900
  # Número máximo de intentos fallidos permitidos antes de bloquear al usuario.
  deny: 5
  # Número de cambios de contraseña después de los cuales un usuario puede reutilizar una contraseña anterior.
  # CIS requiere un valor de 5 o más.
  remember: 12


# ------------------------------------------------------------   
#                    ACCOUNT POLICIES (5.5)
# ------------------------------------------------------------   

# Configure Account Policies
rhel8_cis_rule_5_5_1: true
rhel8_cis_rule_5_5_2: true
rhel8_cis_rule_5_5_3: true
rhel8_cis_rule_5_5_4: true
rhel8_cis_rule_5_5_5: true
rhel8_cis_rule_5_5_6: true
rhel8_cis_rule_5_5_7: true
rhel8_cis_rule_5_5_8: true
rhel8_cis_rule_5_5_8_authselect: true ## Depende del perfil personalizado de authselect para agregar módulo pam_umask
rhel8_cis_rule_5_5_9: true
rhel8_cis_rule_5_5_10: true


## Section 5.5 - Ensure system accounts are secured - prelim
# UID mínimo a partir del cual se consideran cuentas de usuario "normales".
# Este valor puede ser sobrescrito dinámicamente si `discover_int_uid` se establece en `true`.
min_int_uid: 1000


## Section 5.5.1-3: Shadow Password Suite Parameters
rhel8_cis_pass:
  ## Control 5.5.1 - Ensure password expiration is 365 days or less
  # Número de días tras los cuales expira la contraseña.
  # CIS requiere un valor de 365 o menos.
  max_days: 42

  ## Control 5.5.2 - Ensure minimum days between password changes is 7 or more
  # Número mínimo de días entre cambios de contraseña.
  # CIS requiere un valor de al menos 1.
  min_days: 7

  ## Control 5.5.3 - Ensure password expiration warning days is 7 or more
  # Número de días de antelación con los que se avisará al usuario antes de la expiración de su contraseña.
  # CIS requiere un valor de al menos 7.
  warn_age: 7


## Section 5.5.1 - Excluded users for correct PASS_MAX_DAYS for existing users
# Lista de usuarios críticos que no deben verse afectados automáticamente
# por las políticas de cambio de contraseña (gestión manual según política).
excluded_users:
  - root
  - adminso
  - opc
  - psoft
  - psadm1
  - psadm2
  - psadm3
  - oracle
  - oracle2 
  - esadm1
  - proactiva
  - iacolcoauto
  - ansible_test
  - halt
  - shutdown
  - sync
  - nfsnobody
  - nobody

# Shells considerados no interactivos / de sistema
allowed_shells:
  - "/bin/false"
  - "/usr/sbin/nologin"
  - "/sbin/nologin"
  - "/dev/null"

## Allow the forcing of setting user_max_days for logins.
# ADVERTENCIA: puede afectar el acceso de usuarios que se conectan actualmente.
# Tarea crítica: en la auditoría de configuración sensible se omiten usuarios por debajo de UID 1000
# y cuentas de usuario críticas, según la lista anterior.
rhel8_cis_force_user_maxdays: true

## Allow the force setting of minimum days between changing the password
# ADVERTENCIA: puede afectar el acceso actual de usuarios.
rhel8_cis_force_user_mindays: true

## Allow the forcing of number of days before warning users of password expiry
# ADVERTENCIA: puede afectar el acceso actual de usuarios.
rhel8_cis_force_user_warnage: true


## Control 5.5.4 - Ensure inactive password lock is 30 days or less
rhel8_cis_inactivelock:
  # Número de días de inactividad antes de que la cuenta sea bloqueada.
  # CIS requiere un valor de 30 días o menos.
  lock_days: 30


## Control 5.5.5 - Ensure all users last password change date is in the past
# Si se establece en 'true', Ansible expirará contraseñas de cuentas cuya fecha de
# último cambio de contraseña esté en el futuro.
# Si se establece en 'false', solo se mostrarán los usuarios en infracción.
rhel8_cis_futurepwchgdate_autofix: true


## 5.5.9 - Account policies
# Variable responsable de garantizar que el tiempo de inactividad por defecto
# en la sesión de shell de los usuarios sea de 900 segundos o menos.
# El valor se expresa en segundos. 900 segundos = 15 minutos.
rhel8_cis_shell_timeout: 900
