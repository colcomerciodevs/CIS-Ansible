---
- name: Inspeccionar control CIS con Goss
  hosts: "{{ target_ip | default('localhost') }}" 
  become: true
  vars:
    audit_failures: []  # Variable para registrar errores
  tasks:
    - name: Copiar el binario de Goss al servidor remoto
      ansible.builtin.copy:
        src: goss/goss
        dest: /usr/local/bin/goss
        mode: '0755'

    - name: Copiar el archivo de configuración de Goss
      ansible.builtin.copy:
        content: |
          file:
            /etc/ssh/sshd_config:
              exists: true
              mode: "0600"
              contents:
                - "PermitRootLogin no"
        dest: /tmp/goss.yaml
        mode: '0644'

    - name: Ejecutar validación de Goss
      ansible.builtin.command: /usr/local/bin/goss --gossfile /tmp/goss.yaml validate -f documentation
      register: goss_result
      failed_when: false  # No detener el playbook si falla la auditoría
      changed_when: false

    - name: Registrar errores si los hay
      ansible.builtin.set_fact:
        audit_failures: "{{ audit_failures + [goss_result.stdout] }}"
      when: goss_result.rc != 0

    - name: Mostrar resultados de la validación
      ansible.builtin.debug:
        msg: |
          Resultados de la validación de Goss:
          {{ goss_result.stdout }}

    - name: Mostrar resumen de auditorías fallidas
      ansible.builtin.debug:
        msg: |
          Resumen de auditorías fallidas:
          {{ audit_failures | join('\n') }}
      when: audit_failures | length > 0



